<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laurimate - Pepper Edition</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f3f4f6; margin: 0; padding: 20px; }
    .wrap { max-width: 720px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,.08); overflow: hidden; }
    header { padding: 14px 16px; background: #111827; color: #fff; font-weight: 700; }
    #chat { height: 55vh; overflow: auto; padding: 16px; border-bottom: 1px solid #eee; }
    .row { display: flex; margin: 10px 0; }
    .me { justify-content: flex-end; }
    .bot { justify-content: flex-start; }
    .bubble { max-width: 75%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; white-space: pre-wrap; word-break: break-word; }
    .me .bubble { background: #2563eb; color: #fff; border-bottom-right-radius: 6px; }
    .bot .bubble { background: #e5e7eb; color: #111827; border-bottom-left-radius: 6px; }
    footer { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: #fafafa; }
    input { flex: 1; min-width: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; }
    button, .btn { padding: 10px 14px; border: 0; border-radius: 10px; background: #111827; color: #fff; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    #mic { font-size: 20px; background: #ef4444; }
    select { padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>Laurimate - Pepper Beta</header>
    <div id="chat"></div>
    <footer>
      <input id="msg" placeholder="Type to Pepper..." autocomplete="off" />
      <button id="send">Send</button>
      <select id="voiceLang">
        <option value="English">English</option>
        <option value="Finnish">Finnish</option>
        <option value="Swedish">Swedish</option>
      </select>
      <button id="mic">ðŸŽ¤</button>
    </footer>
  </div>

<script src="qimessaging.js"></script>

  <script>
    var FUNCTION_URL = "https://chatwithgemini-wfqmz3bdja-uc.a.run.app";
    var ROBOT_IP = "192.168.0.118";
    
    var session;
    var tts, asr, mem;
    var isListening = false;

    // DOM Elements
    var chat = document.getElementById("chat");
    var msg = document.getElementById("msg");
    var sendBtn = document.getElementById("send");
    var micBtn = document.getElementById("mic");
    var langSelect = document.getElementById("voiceLang");

    // 1. Initialize Robot Connection
    QiSession(function(s) {
      console.log("Connected to Pepper!");
      session = s;
      
      session.service("ALTextToSpeech").done(function(ins) { tts = ins; });
      session.service("ALSpeechRecognition").done(function(ins) { asr = ins; });
      session.service("ALMemory").done(function(ins) { 
        mem = ins;
        setupSpeechSignals();
      });

      addBubble("Connected to Pepper. I'm ready!", "bot");
    }, function() {
      addBubble("Error: Could not connect to Pepper's brain.", "bot");
    }, ROBOT_IP);

    // 2. Setup Pepper's Ears (Speech Recognition)
    function setupSpeechSignals() {
      mem.subscriber("WordRecognized").done(function(sub) {
        sub.signal.connect(function(data) {
          // data[0] is word, data[1] is confidence
          if (data[1] > 0.4 && isListening) {
            var heard = data[0].replace("<...>", "").trim();
            if (heard) {
              stopListening();
              sendMessage(heard);
            }
          }
        });
      });
    }

    // 3. Text to Speech (Robot Voice)
    function speakText(text) {
      if (tts) {
        // Clean text for Pepper (no emojis)
        var clean = text.replace(/[^\x00-\x7F]/g, ""); 
        tts.setLanguage(langSelect.value);
        tts.say(clean);
      }
    }

    // 4. Send to Gemini API
    function sendMessage(forcedText) {
      var text = forcedText ? forcedText : msg.value;
      if (!text) return;

      addBubble(text, "me");
      msg.value = "";
      sendBtn.disabled = true;
      var typingRow = addBubble("Pepper is thinking...", "bot");

      var xhr = new XMLHttpRequest();
      xhr.open("POST", FUNCTION_URL, true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (typingRow && typingRow.parentNode) typingRow.parentNode.removeChild(typingRow);
          sendBtn.disabled = false;
          if (xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            addBubble(data.reply || "...", "bot");
          } else {
            addBubble("Error: Gemini unreachable.", "bot");
          }
        }
      };
      xhr.send(JSON.stringify({ message: text }));
    }

    // 5. Mic Toggle Logic
    micBtn.onclick = function() {
      if (!asr) return;
      if (!isListening) {
        isListening = true;
        micBtn.style.background = "#22c55e"; // Green
        asr.subscribe("Laurimate");
      } else {
        stopListening();
      }
    };

    function stopListening() {
      isListening = false;
      micBtn.style.background = "#ef4444"; // Red
      if (asr) asr.unsubscribe("Laurimate");
    }

    // UI Helpers
    function addBubble(text, who) {
      var row = document.createElement("div");
      row.className = "row " + who;
      var bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      if (who === "bot") speakText(text);
      return row;
    }

    sendBtn.onclick = function () { sendMessage(); };
    msg.onkeypress = function (e) { if (e.keyCode === 13) sendMessage(); };
  </script>
</body>
</html>